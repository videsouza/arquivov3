<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Boxes | Hub.Doc</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f7931e',
                        'primary-hover': '#d67d12',
                        dark: '#1f2937',
                        light: '#f3f4f6',
                        // Cores dos Boxes
                        boxFree: '#10b981',   // Verde (Livre)
                        boxPartial: '#f59e0b', // Laranja (Parcial)
                        boxFull: '#ef4444',    // Vermelho (Cheio)
                        boxCrit: '#1f2937'    // Preto (Crítico)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Grid das Estantes */
        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 4px;
        }
        
        /* Box Individual */
        .box-item {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .box-item:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        
        /* Tooltip */
        .tooltip {
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: #fff; padding: 6px 10px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; z-index: 20; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .box-item:hover .tooltip { opacity: 1; }

        .drop-active { border-color: #f7931e !important; background-color: #fff7ed !important; }
    </style>
</head>
<body class="flex h-screen text-gray-800 overflow-hidden">

    <aside class="w-72 bg-dark text-white flex flex-col justify-between hidden md:flex h-full shrink-0 shadow-xl z-30">
        <div>
            <div class="p-8 border-b border-gray-700">
                <h1 class="text-2xl font-light tracking-wide text-white">Hub<span class="font-bold text-primary">.Doc</span></h1>
                <p class="text-[10px] text-gray-400 mt-2 font-light tracking-wider uppercase">Gestão de Espaço</p>
            </div>
            <nav class="mt-8 px-4 space-y-3">
                <a href="index.html" class="w-full text-left px-4 py-3 rounded border border-gray-600 hover:bg-gray-700 text-gray-300 hover:text-white transition flex items-center gap-3 mb-6">
                    <i class="fa-solid fa-arrow-left w-5 text-primary"></i> <span class="font-medium text-sm">Voltar ao Hub</span>
                </a>
                <div class="px-4 py-2 text-[10px] text-gray-500 uppercase tracking-widest font-bold border-b border-gray-700 mb-2">Controles</div>
                <button onclick="document.getElementById('file-input').click()" class="w-full text-left px-4 py-3 rounded bg-primary hover:bg-primary-hover text-white shadow-lg transition flex items-center gap-3">
                    <i class="fa-solid fa-upload w-5"></i> <span class="font-medium text-sm">Carregar Mapa</span>
                </button>
                <button onclick="imprimirRelatorio()" class="w-full text-left px-4 py-3 rounded hover:bg-gray-700 text-gray-400 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-print w-5"></i> <span class="font-medium text-sm">Imprimir Relatório</span>
                </button>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-700 bg-gray-900/50">
            <p class="text-[10px] text-gray-500 text-center">Visualizador v2.1 (Fix)<br>&copy; 2025</p>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-light relative">
        <header class="bg-white border-b border-gray-200 p-6 flex justify-between items-center shadow-sm z-10 shrink-0 h-20">
            <div>
                <h2 class="text-2xl font-serif font-bold text-gray-800 flex items-center gap-3">
                    <i class="fa-solid fa-cubes text-primary text-xl"></i> Mapa de Ocupação
                </h2>
                <p class="text-xs text-gray-500 font-sans mt-1">Visão gráfica das estantes e caixas arquivadas.</p>
            </div>
            <div id="file-info" class="hidden px-3 py-1 bg-green-50 text-green-700 text-xs font-bold rounded border border-green-200 flex items-center gap-2">
                <i class="fa-solid fa-check-circle"></i> <span id="filename">arquivo.xlsx</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 fade-in scroll-smooth relative">
            
            <div id="upload-screen" class="max-w-2xl mx-auto mt-10 text-center fade-in">
                <div id="drop-zone" class="bg-white border-2 border-dashed border-gray-300 rounded-2xl p-12 transition-all cursor-pointer hover:border-primary hover:bg-orange-50/30 group shadow-sm">
                    <div class="w-20 h-20 bg-orange-100 text-primary rounded-full flex items-center justify-center text-3xl mx-auto mb-6 group-hover:scale-110 transition duration-300">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Carregar Mapeamento</h3>
                    <p class="text-sm text-gray-400 mb-6">Arraste sua planilha (.xlsx) contendo Corredor, Estante e Prateleira.</p>
                    <button class="bg-dark text-white px-8 py-3 rounded-lg font-bold hover:bg-black transition shadow-lg flex items-center gap-2 mx-auto">
                        <i class="fa-solid fa-folder-open"></i> Selecionar Arquivo
                    </button>
                    <input type="file" id="file-input" accept=".xlsx, .xls" class="hidden">
                </div>
                <div id="error-msg" class="hidden mt-6 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 text-left rounded shadow-sm text-sm"></div>
            </div>

            <div id="dashboard-area" class="hidden fade-in space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-6 justify-center md:justify-start">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-emerald-500"></div><span class="text-xs font-bold text-gray-600">Livre</span></div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-amber-500"></div><span class="text-xs font-bold text-gray-600">Ocupado (1-5)</span></div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-red-500"></div><span class="text-xs font-bold text-gray-600">Cheio (6+)</span></div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-gray-800"></div><span class="text-xs font-bold text-gray-600">Crítico (10+)</span></div>
                </div>

                <div id="shelves-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>

            <div id="loader" class="hidden fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
                <p class="mt-4 text-sm font-bold text-gray-500 animate-pulse">Processando mapa...</p>
            </div>
        </div>
    </main>

    <script>
        let dadosRelatorio = null;
        
        // --- Drag & Drop ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drop-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drop-active'); );
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('drop-active');
            if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) processFile(e.target.files[0]); });

        function processFile(file) {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" }); // defval garante que células vazias não quebrem
                    
                    if(jsonData.length === 0) throw new Error("A planilha parece estar vazia.");
                    
                    renderMap(jsonData, file.name);
                } catch (err) {
                    showError("Erro ao ler arquivo: " + err.message);
                    document.getElementById('loader').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showError(msg) {
            const errDiv = document.getElementById('error-msg');
            errDiv.innerHTML = `<strong><i class="fa-solid fa-triangle-exclamation"></i> Ops!</strong> ${msg}`;
            errDiv.classList.remove('hidden');
        }

        function renderMap(data, filename) {
            // --- DETECÇÃO INTELIGENTE DE COLUNAS ---
            const keys = Object.keys(data[0]);
            
            // Regex flexível para encontrar colunas mesmo com nomes diferentes
            const colCorr = keys.find(k => /corr|bloco/i.test(k));
            const colEst = keys.find(k => /estante|mod|modulo/i.test(k));
            const colPrat = keys.find(k => /prat|nivel/i.test(k));
            const colBox = keys.find(k => /caixa|box|numero|cx/i.test(k));
            const colTipo = keys.find(k => /tipo|assunto|doc/i.test(k)); // Opcional

            if (!colCorr || !colEst || !colPrat || !colBox) {
                showError(`
                    Não identificamos as colunas necessárias.<br>
                    Verifique se sua planilha tem cabeçalho com: <strong>Corredor, Estante, Prateleira, Caixa</strong>.<br>
                    <span class="text-xs text-gray-500 mt-2 block">Colunas encontradas: ${keys.join(', ')}</span>
                `);
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            // --- PROCESSAMENTO ---
            const mapData = {};
            let stats = { totalDocs: 0, totalBoxes: 0, tipos: {} };

            data.forEach(row => {
                const corr = row[colCorr];
                const est = row[colEst];
                const prat = row[colPrat];
                const cx = row[colBox];
                const tipo = colTipo ? row[colTipo] : "Geral";

                // Ignora linhas vazias ou inválidas
                if(corr === undefined || est === undefined || cx === undefined) return;

                const shelfKey = `${corr}-${est}`;
                
                if(!mapData[shelfKey]) mapData[shelfKey] = { c: corr, e: est, prats: {} };
                if(!mapData[shelfKey].prats[prat]) mapData[shelfKey].prats[prat] = {};
                if(!mapData[shelfKey].prats[prat][cx]) mapData[shelfKey].prats[prat][cx] = { qtd: 0, tipos: [] };

                mapData[shelfKey].prats[prat][cx].qtd++;
                mapData[shelfKey].prats[prat][cx].tipos.push(tipo);
                
                stats.totalDocs++;
                stats.tipos[tipo] = (stats.tipos[tipo] || 0) + 1;
            });

            // --- RENDERIZAÇÃO ---
            const container = document.getElementById('shelves-container');
            container.innerHTML = '';
            stats.totalBoxes = 0;

            const sortedShelves = Object.keys(mapData).sort((a,b) => {
                // Tenta ordenar numericamente se possível
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });

            if(sortedShelves.length === 0) {
                showError("Colunas encontradas, mas nenhum dado válido foi processado. Verifique se as células não estão vazias.");
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            sortedShelves.forEach(key => {
                const shelf = mapData[key];
                
                let html = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition group">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                            <h3 class="text-sm font-bold text-gray-700">
                                <i class="fa-solid fa-server text-primary mr-2"></i> Corredor ${shelf.c} <span class="text-gray-300 mx-2">|</span> Estante ${shelf.e}
                            </h3>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xs group-hover:text-primary transition"></i>
                        </div>
                        <div class="space-y-3">
                `;

                // Ordena prateleiras
                Object.keys(shelf.prats).sort((a,b) => a - b).forEach(pKey => {
                    html += `
                        <div class="bg-gray-50 p-2 rounded-lg border border-gray-100">
                            <div class="text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider flex justify-between">
                                <span>Prateleira ${pKey}</span>
                            </div>
                            <div class="shelf-grid">
                    `;

                    // Ordena Boxes
                    const boxes = shelf.prats[pKey];
                    Object.keys(boxes).sort((a,b) => a - b).forEach(bKey => {
                        const box = boxes[bKey];
                        stats.totalBoxes++;
                        
                        // Cores
                        let colorClass = 'bg-emerald-500';
                        if(box.qtd > 0) colorClass = 'bg-amber-500';
                        if(box.qtd > 5) colorClass = 'bg-red-500';
                        if(box.qtd > 10) colorClass = 'bg-gray-800';

                        // Resumo Tooltip
                        const topTips = box.tipos.slice(0,2).join(', ') + (box.tipos.length > 2 ? '...' : '');

                        html += `
                            <div class="box-item ${colorClass}">
                                ${bKey}
                                <div class="tooltip">
                                    <strong>Box ${bKey}</strong><br>
                                    ${box.qtd} docs<br>
                                    <span class="opacity-70 text-[9px]">${topTips}</span>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                });

                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Atualiza UI Final
            dadosRelatorio = stats;
            document.getElementById('filename').innerText = filename;
            document.getElementById('file-info').classList.remove('hidden');
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('dashboard-area').classList.remove('hidden');
            document.getElementById('loader').classList.add('hidden');
        }

        function imprimirRelatorio() {
            if(!dadosRelatorio) return alert("Carregue um mapa primeiro.");
            
            const win = window.open('', '', 'width=900,height=600');
            const d = dadosRelatorio;
            
            // Monta tabela de tipos
            let rows = Object.entries(d.tipos)
                .sort(([,a], [,b]) => b - a)
                .map(([k,v]) => `<tr><td>${k}</td><td style="text-align:right">${v}</td></tr>`)
                .join('');

            win.document.write(`
                <html><head><title>Relatório de Ocupação</title>
                <style>
                    body { font-family: sans-serif; padding: 40px; color: #333; }
                    h1 { border-bottom: 2px solid #f7931e; padding-bottom: 10px; color: #f7931e; }
                    .kpi { display: flex; gap: 20px; margin: 30px 0; }
                    .card { background: #f9f9f9; padding: 20px; flex: 1; text-align: center; border-radius: 8px; border: 1px solid #ddd; }
                    .val { font-size: 24px; font-weight: bold; display: block; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f0f0f0; }
                </style>
                </head><body>
                    <h1>Relatório de Ocupação Física</h1>
                    <div class="kpi">
                        <div class="card"><span class="val">${d.totalBoxes}</span> Boxes Mapeados</div>
                        <div class="card"><span class="val">${d.totalDocs}</span> Documentos</div>
                        <div class="card"><span class="val">${Object.keys(d.tipos).length}</span> Tipos de Doc</div>
                    </div>
                    <h3>Detalhamento por Tipo</h3>
                    <table><thead><tr><th>Tipo Documental</th><th style="text-align:right">Qtd</th></tr></thead><tbody>${rows}</tbody></table>
                    <p style="margin-top:50px; font-size:12px; color:#999; text-align:center">Gerado pelo Hub.Doc</p>
                </body></html>
            `);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }
    </script>
</body>
</html>
