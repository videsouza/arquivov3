<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Boxes | Diagnóstico</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f7931e',
                        dark: '#1f2937',
                        light: '#f3f4f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .shelf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 4px; }
        .box-item {
            aspect-ratio: 1; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: white; cursor: pointer; position: relative;
        }
        .box-item:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .tooltip {
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: #fff; padding: 6px 10px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; z-index: 20;
        }
        .box-item:hover .tooltip { opacity: 1; }
    </style>
</head>
<body class="flex h-screen text-gray-800 overflow-hidden">

    <aside class="w-72 bg-dark text-white flex flex-col justify-between hidden md:flex h-full shrink-0 shadow-xl z-30">
        <div>
            <div class="p-8 border-b border-gray-700">
                <h1 class="text-2xl font-light tracking-wide text-white">Hub<span class="font-bold text-primary">.Doc</span></h1>
                <p class="text-[10px] text-gray-400 mt-2 font-light tracking-wider uppercase">Versão Diagnóstico</p>
            </div>
            <nav class="mt-8 px-4 space-y-3">
                <a href="index.html" class="w-full text-left px-4 py-3 rounded border border-gray-600 hover:bg-gray-700 text-gray-300 hover:text-white transition flex items-center gap-3 mb-6">
                    <i class="fa-solid fa-arrow-left w-5 text-primary"></i> <span class="font-medium text-sm">Voltar</span>
                </a>
                
                <button onclick="acionarInput()" class="w-full text-left px-4 py-3 rounded bg-primary hover:bg-primary-hover text-white shadow-lg transition flex items-center gap-3">
                    <i class="fa-solid fa-upload w-5"></i> <span class="font-medium text-sm">Carregar Mapa</span>
                </button>

                <div id="status-lib" class="mt-4 p-2 text-[10px] bg-gray-800 rounded text-center text-gray-400">
                    Verificando bibliotecas...
                </div>
            </nav>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-light relative">
        <header class="bg-white border-b border-gray-200 p-6 flex justify-between items-center shadow-sm z-10 shrink-0 h-20">
            <h2 class="text-2xl font-serif font-bold text-gray-800 flex items-center gap-3">
                <i class="fa-solid fa-bug text-primary text-xl"></i> Modo Diagnóstico
            </h2>
        </header>

        <div class="flex-1 overflow-y-auto p-8 fade-in relative">
            
            <div id="upload-screen" class="max-w-2xl mx-auto mt-10 text-center">
                <div onclick="acionarInput()" class="bg-white border-2 border-dashed border-gray-300 rounded-2xl p-12 cursor-pointer hover:border-primary hover:bg-orange-50/30 group shadow-sm">
                    <i class="fa-solid fa-file-excel text-6xl text-gray-300 mb-4 group-hover:text-primary transition"></i>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Clique aqui para carregar</h3>
                    <p class="text-sm text-gray-400">Selecione o arquivo Excel (.xlsx)</p>
                </div>
                
                <input type="file" id="file-input" accept=".xlsx, .xls" style="display:none" onchange="arquivoSelecionado(this)">
                
                <div id="error-log" class="mt-6 text-left hidden"></div>
            </div>

            <div id="dashboard-area" class="hidden space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center">
                    <span class="font-bold text-lg text-primary" id="dash-title">Mapa Gerado</span>
                </div>
                <div id="shelves-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </div>

        </div>
    </main>

    <script>
        // 1. VERIFICAÇÃO INICIAL AO CARREGAR
        window.onload = function() {
            const statusDiv = document.getElementById('status-lib');
            if (typeof XLSX === 'undefined') {
                statusDiv.innerHTML = '<span class="text-red-400 font-bold">ERRO: XLSX não carregou!</span><br>Verifique sua internet.';
                alert("ERRO CRÍTICO: A biblioteca de leitura de Excel não foi carregada. O sistema não funcionará sem internet.");
            } else {
                statusDiv.innerHTML = '<span class="text-green-400 font-bold">Sistema Pronto</span><br>Bibliotecas OK.';
            }
        };

        // 2. FUNÇÃO DIRETA DE CLIQUE
        function acionarInput() {
            console.log("Botão clicado.");
            document.getElementById('file-input').click();
        }

        // 3. PROCESSAMENTO DO ARQUIVO
        function arquivoSelecionado(input) {
            if (input.files.length === 0) return;
            
            const file = input.files[0];
            console.log("Arquivo recebido:", file.name);
            
            // Log visual para o usuário
            const logDiv = document.getElementById('error-log');
            logDiv.classList.remove('hidden');
            logDiv.innerHTML = `<div class="bg-blue-50 text-blue-700 p-3 rounded">Lendo arquivo: <strong>${file.name}</strong>... aguarde.</div>`;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log("Binário lido. Processando XLSX...");
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

                    console.log("Dados brutos:", jsonData);

                    if (!jsonData || jsonData.length === 0) throw new Error("A planilha está vazia ou ilegível.");

                    renderizarMapa(jsonData);

                } catch (err) {
                    console.error(err);
                    logDiv.innerHTML = `<div class="bg-red-50 text-red-700 p-3 rounded border border-red-200"><strong>Erro:</strong> ${err.message}</div>`;
                }
            };

            reader.onerror = function() {
                logDiv.innerHTML = `<div class="bg-red-50 text-red-700 p-3 rounded">Erro ao ler o arquivo físico.</div>`;
            };

            reader.readAsArrayBuffer(file);
        }

        // 4. RENDERIZAÇÃO ROBUSTA
        function renderizarMapa(data) {
            const keys = Object.keys(data[0]);
            
            // Tenta achar colunas ignorando maiúsculas/minúsculas
            const colCorr = keys.find(k => k.match(/corr|bloco/i));
            const colEst = keys.find(k => k.match(/estante|mod/i));
            const colPrat = keys.find(k => k.match(/prat|nivel/i));
            const colBox = keys.find(k => k.match(/box|cx|caixa/i));

            if (!colCorr || !colEst || !colPrat || !colBox) {
                const logDiv = document.getElementById('error-log');
                logDiv.innerHTML = `
                    <div class="bg-amber-50 text-amber-800 p-4 rounded border border-amber-200">
                        <strong>Colunas não identificadas!</strong><br>
                        O sistema precisa de colunas parecidas com: "Corredor", "Estante", "Prateleira", "Box".<br><br>
                        <strong>Colunas encontradas no seu arquivo:</strong><br>
                        ${keys.join(', ')}
                    </div>`;
                return;
            }

            const mapData = {};
            let countBoxes = 0;

            data.forEach(row => {
                const c = row[colCorr];
                const e = row[colEst];
                const p = row[colPrat];
                const b = row[colBox];

                if (c == undefined || e == undefined || b == undefined) return;

                const key = `${c}-${e}`;
                if (!mapData[key]) mapData[key] = { c: c, e: e, prats: {} };
                if (!mapData[key].prats[p]) mapData[key].prats[p] = [];
                
                mapData[key].prats[p].push(b);
                countBoxes++;
            });

            // Montar HTML
            const container = document.getElementById('shelves-container');
            container.innerHTML = '';

            if (countBoxes === 0) {
                 document.getElementById('error-log').innerHTML = `<div class="bg-red-50 text-red-700 p-3 rounded">Nenhum box válido encontrado nas linhas.</div>`;
                 return;
            }

            // Ordena e Renderiza
            Object.keys(mapData).sort().forEach(k => {
                const shelf = mapData[k];
                let html = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                        <div class="font-bold text-gray-700 mb-3 border-b pb-2">Corredor ${shelf.c} - Estante ${shelf.e}</div>
                        <div class="space-y-2">`;
                
                Object.keys(shelf.prats).sort().forEach(pk => {
                    html += `<div class="bg-gray-50 p-2 rounded"><div class="text-[10px] uppercase font-bold text-gray-400 mb-1">Prateleira ${pk}</div><div class="shelf-grid">`;
                    
                    shelf.prats[pk].sort().forEach(boxVal => {
                         html += `<div class="box-item bg-emerald-500">${boxVal}</div>`;
                    });
                    
                    html += `</div></div>`;
                });

                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Sucesso
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('dashboard-area').classList.remove('hidden');
            document.getElementById('dash-title').innerText = `${countBoxes} Boxes Mapeados com Sucesso`;
        }
    </script>
</body>
</html>
